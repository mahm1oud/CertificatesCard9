# دليل النسخ الاحتياطي واستعادة البيانات

## نظرة عامة

يوفر هذا الدليل معلومات تفصيلية حول كيفية إنشاء وإدارة النسخ الاحتياطية للنظام، وكيفية استعادة البيانات في حالة حدوث مشكلات.

## محتويات الدليل

1. [استراتيجية النسخ الاحتياطي](#استراتيجية-النسخ-الاحتياطي)
2. [إنشاء نسخة احتياطية](#إنشاء-نسخة-احتياطية)
3. [استعادة النسخة الاحتياطية](#استعادة-النسخة-الاحتياطية)
4. [جدولة النسخ الاحتياطي التلقائي](#جدولة-النسخ-الاحتياطي-التلقائي)
5. [أفضل الممارسات](#أفضل-الممارسات)
6. [استكشاف المشكلات وإصلاحها](#استكشاف-المشكلات-وإصلاحها)

## استراتيجية النسخ الاحتياطي

### عناصر النظام التي تحتاج إلى نسخ احتياطي

1. **قاعدة البيانات**: تحتوي على جميع البيانات الأساسية (المستخدمين، القوالب، الشهادات، الإعدادات)
2. **الملفات المحملة**: الصور والشعارات والتوقيعات التي تم تحميلها
3. **ملفات التخصيص**: أي تعديلات مخصصة أجريت على التطبيق
4. **ملفات الإعدادات**: ملفات التكوين مثل `.env`

### أنواع النسخ الاحتياطي

1. **نسخ احتياطي كامل**: نسخة كاملة من جميع البيانات والملفات
2. **نسخ احتياطي لقاعدة البيانات فقط**: يشمل فقط بيانات قاعدة البيانات
3. **نسخ احتياطي تفاضلي**: يحفظ فقط التغييرات منذ النسخة الاحتياطية الأخيرة

## إنشاء نسخة احتياطية

### استخدام أداة النسخ الاحتياطي المدمجة

النظام يتضمن أداة مدمجة للنسخ الاحتياطي. لاستخدامها:

```bash
# إنشاء نسخة احتياطية كاملة لقاعدة البيانات
node install/scripts/backup.js backup

# عرض قائمة النسخ الاحتياطية الموجودة
node install/scripts/backup.js list
```

النسخ الاحتياطية يتم تخزينها في مجلد `install/backups/` ويتم تسميتها تلقائيًا باستخدام الطابع الزمني.

### النسخ الاحتياطي اليدوي

#### 1. نسخ احتياطي لقاعدة البيانات

```bash
# باستخدام mysqldump مباشرة
mysqldump -h [HOST] -u [USERNAME] -p [DATABASE_NAME] > backup_[DATE].sql

# ضغط ملف النسخة الاحتياطية
gzip backup_[DATE].sql
```

#### 2. نسخ احتياطي للملفات

```bash
# نسخ احتياطي للمجلدات المهمة
tar -czvf files_backup_[DATE].tar.gz uploads/ fonts/ static/

# أو نسخ احتياطي لجميع ملفات التطبيق
tar -czvf full_app_backup_[DATE].tar.gz .
```

#### 3. نسخ احتياطي لملفات الإعدادات

```bash
# نسخ ملف .env
cp .env .env.backup_[DATE]

# نسخ ملفات الإعدادات الأخرى
mkdir -p config_backup_[DATE]
cp install/config/*.json config_backup_[DATE]/
```

## استعادة النسخة الاحتياطية

### استخدام أداة الاستعادة المدمجة

لاستعادة قاعدة البيانات من نسخة احتياطية:

```bash
# استعادة نسخة احتياطية محددة
node install/scripts/backup.js restore install/backups/backup_2025-05-03_120000.sql.gz
```

### الاستعادة اليدوية

#### 1. استعادة قاعدة البيانات

```bash
# فك ضغط ملف النسخة الاحتياطية (إذا كان مضغوطًا)
gunzip backup_[DATE].sql.gz

# استعادة قاعدة البيانات
mysql -h [HOST] -u [USERNAME] -p [DATABASE_NAME] < backup_[DATE].sql
```

#### 2. استعادة الملفات

```bash
# استعادة الملفات من النسخة الاحتياطية
tar -xzvf files_backup_[DATE].tar.gz -C /path/to/app/
```

#### 3. استعادة ملفات الإعدادات

```bash
# استعادة ملف .env
cp .env.backup_[DATE] .env

# استعادة ملفات الإعدادات الأخرى
cp config_backup_[DATE]/* install/config/
```

## جدولة النسخ الاحتياطي التلقائي

### باستخدام Cron Jobs

يمكنك جدولة النسخ الاحتياطي التلقائي باستخدام Cron Jobs على نظام Linux:

```bash
# فتح محرر crontab
crontab -e

# إضافة مهمة للنسخ الاحتياطي اليومي الساعة 3 صباحًا
0 3 * * * cd /path/to/app && node install/scripts/backup.js backup

# إضافة مهمة لتنظيف النسخ الاحتياطية القديمة (مرة في الأسبوع)
0 4 * * 0 cd /path/to/app && node install/scripts/backup.js cleanup
```

### إعدادات النسخ الاحتياطي التلقائي

يمكنك تخصيص إعدادات النسخ الاحتياطي التلقائي في ملف `install/config/config.json`:

```json
{
  "backup": {
    "maxBackups": 7,        // الاحتفاظ بآخر 7 نسخ احتياطية فقط
    "compressBackups": true, // ضغط النسخ الاحتياطية
    "backupDir": "install/backups", // مجلد النسخ الاحتياطية
    "includeUploads": true  // تضمين مجلد الملفات المحملة
  }
}
```

## أفضل الممارسات

### توصيات للنسخ الاحتياطي

1. **التكرار**: قم بعمل نسخ احتياطية بشكل منتظم (يوميًا للمواقع النشطة)
2. **التنوع**: احتفظ بنسخ احتياطية في أماكن مختلفة (محليًا وخارج الموقع)
3. **الاختبار**: اختبر عملية استعادة النسخ الاحتياطية بانتظام للتأكد من صحتها
4. **التوثيق**: احتفظ بسجل للنسخ الاحتياطية وعمليات الاستعادة

### توصيات الأمان

1. **التشفير**: قم بتشفير النسخ الاحتياطية التي تحتوي على بيانات حساسة
2. **التقييد**: قيد صلاحيات الوصول إلى مجلد النسخ الاحتياطية
3. **النقل الآمن**: استخدم بروتوكولات آمنة عند نقل النسخ الاحتياطية

## استكشاف المشكلات وإصلاحها

### مشكلات شائعة وحلولها

| المشكلة | الحل |
|---------|------|
| فشل إنشاء نسخة احتياطية | تحقق من صلاحيات الوصول إلى مجلد النسخ الاحتياطية ومساحة التخزين المتاحة |
| خطأ "Access denied" عند استعادة قاعدة البيانات | تحقق من صلاحيات المستخدم المستخدم للاتصال بقاعدة البيانات |
| ملف النسخة الاحتياطية كبير جدًا | استخدم الضغط وفكر في استبعاد الملفات غير الضرورية |
| خطأ أثناء استعادة النسخة الاحتياطية | تأكد من تطابق إصدار قاعدة البيانات مع النسخة الاحتياطية |

### سجلات النسخ الاحتياطي

يتم حفظ سجلات عمليات النسخ الاحتياطي في `install/logs/backup.log`. راجع هذا الملف للحصول على معلومات تفصيلية حول عمليات النسخ الاحتياطي وأي أخطاء.

---

## مساعدة إضافية

إذا كنت بحاجة إلى مزيد من المساعدة بخصوص النسخ الاحتياطي واستعادة البيانات، يرجى الاتصال بفريق الدعم الفني.