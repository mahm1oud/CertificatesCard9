# دليل تحديثات النظام

## نظرة عامة

هذا الدليل يشرح كيفية تحديث النظام إلى الإصدارات الجديدة وكيفية إنشاء تحديثات مخصصة.

## محتويات الدليل

1. [عملية التحديث التلقائي](#عملية-التحديث-التلقائي)
2. [التحديث اليدوي](#التحديث-اليدوي)
3. [إنشاء حزم تحديث مخصصة](#إنشاء-حزم-تحديث-مخصصة)
4. [استكشاف أخطاء التحديث وإصلاحها](#استكشاف-أخطاء-التحديث-وإصلاحها)

## عملية التحديث التلقائي

### أداة التحديث المدمجة

النظام يتضمن أداة تحديث مدمجة تقوم بالعمليات التالية:

1. التحقق من وجود تحديثات جديدة
2. عمل نسخة احتياطية تلقائية قبل التحديث
3. تنزيل وتطبيق التحديثات
4. تحديث هيكل قاعدة البيانات (إذا لزم الأمر)

### خطوات التحديث التلقائي

1. قم بتشغيل أداة التحديث:

```bash
node install/scripts/update.js
```

2. ستقوم الأداة بالتحقق من وجود تحديثات متاحة والإبلاغ عن النتائج.

3. إذا تم العثور على تحديثات، ستطلب الأداة تأكيدًا منك قبل المتابعة.

4. بعد التأكيد، سيتم تنفيذ التحديثات بالترتيب وإبلاغك بالتقدم.

### التحديث من واجهة المستخدم (للإصدارات المستقبلية)

في الإصدارات المستقبلية، سيتضمن النظام واجهة مستخدم للتحديثات يمكن الوصول إليها من لوحة التحكم:

1. تسجيل الدخول كمدير
2. الانتقال إلى قسم "النظام" > "التحديثات"
3. النقر على "التحقق من وجود تحديثات"
4. اتباع التعليمات على الشاشة لتثبيت التحديثات المتاحة

## التحديث اليدوي

### الاستعداد للتحديث

قبل إجراء أي تحديث يدوي، يجب اتباع الخطوات التالية:

1. عمل نسخة احتياطية كاملة من قاعدة البيانات:

```bash
node install/scripts/backup.js backup
```

2. عمل نسخة احتياطية من ملفات التطبيق:

```bash
# مثال باستخدام الأمر tar
tar -czvf app_backup_$(date +%Y%m%d).tar.gz .
```

### تطبيق التحديث اليدوي

1. تنزيل حزمة التحديث من المصدر الرسمي

2. استخراج ملفات التحديث في مجلد مؤقت:

```bash
mkdir -p temp_update
tar -xzvf update_package.tar.gz -C temp_update
```

3. نسخ الملفات المحدثة إلى مجلد التطبيق:

```bash
cp -R temp_update/* .
```

4. تشغيل سكريبت التحديث (إذا كان متاحًا مع حزمة التحديث):

```bash
node update_script.js
```

5. تحديث قاعدة البيانات (إذا لزم الأمر):

```bash
node install/scripts/db-migrate.js
```

## إنشاء حزم تحديث مخصصة

### هيكل ملف التحديث

ملفات التحديث في النظام تتبع التنسيق التالي:

```
update-[VERSION].js
```

حيث `[VERSION]` هو رقم الإصدار، مثل `1.1.0` أو `2.0.1`.

### بنية ملف التحديث

ملف التحديث يجب أن يتضمن دالة `apply` تقوم بتنفيذ خطوات التحديث:

```javascript
/**
 * تحديث للإصدار X.Y.Z
 */
const mysql = require('mysql2/promise');
const fs = require('fs').promises;

async function apply(config) {
  console.log('بدء تطبيق تحديث الإصدار X.Y.Z...');
  
  // الاتصال بقاعدة البيانات
  const connection = await mysql.createConnection({
    host: config.database.host,
    user: config.database.user,
    password: config.database.password,
    database: config.database.database
  });
  
  try {
    // تنفيذ عمليات التحديث هنا
    // مثال: إضافة حقول جديدة
    await connection.execute(`
      ALTER TABLE users 
      ADD COLUMN IF NOT EXISTS example_field VARCHAR(255) DEFAULT NULL
    `);
    
    // تحديث البيانات
    await connection.execute(`
      UPDATE settings SET value = 'new_value' WHERE key = 'example_key'
    `);
    
    // عمليات أخرى...
    
    console.log('✅ تم إكمال تحديث الإصدار X.Y.Z بنجاح!');
  } catch (error) {
    console.error('❌ خطأ أثناء تحديث الإصدار X.Y.Z:', error);
    throw error;
  } finally {
    await connection.end();
  }
}

module.exports = {
  apply
};
```

### وضع ملفات التحديث

ضع ملفات التحديث في المجلد `install/updates/` ليتم اكتشافها تلقائيًا من قبل أداة التحديث.

## استكشاف أخطاء التحديث وإصلاحها

### المشكلات الشائعة وحلولها

| المشكلة | السبب المحتمل | الحل |
|---------|---------------|------|
| فشل التحديث مع خطأ اتصال بقاعدة البيانات | بيانات اعتماد غير صحيحة أو تغييرات في بنية قاعدة البيانات | التحقق من صحة بيانات الاتصال واستعادة النسخة الاحتياطية |
| تعارض الإصدارات | الانتقال من إصدار قديم جدًا إلى إصدار جديد جدًا | تطبيق التحديثات المتوسطة أولاً ثم الانتقال إلى الإصدار المطلوب |
| فقدان الملفات المخصصة | استبدال الملفات المخصصة أثناء التحديث | استعادة الملفات المخصصة من النسخة الاحتياطية |

### استعادة النسخة الاحتياطية بعد فشل التحديث

إذا فشل التحديث وترغب في استعادة النظام إلى حالته السابقة:

1. استعادة قاعدة البيانات:

```bash
node install/scripts/backup.js restore path/to/your/backup.sql.gz
```

2. استعادة ملفات التطبيق:

```bash
# افتراضًا أنك قمت بعمل نسخة احتياطية باستخدام tar
rm -rf ./* # حذف الملفات الحالية (كن حذرًا!)
tar -xzvf app_backup_YYYYMMDD.tar.gz -C .
```

---

## ملاحظات هامة

- يجب دائمًا عمل نسخة احتياطية قبل أي عملية تحديث.
- إذا كان لديك تعديلات مخصصة في الكود، قد تحتاج إلى إعادة تطبيقها بعد التحديث.
- بعض التحديثات قد تتطلب إعادة تشغيل الخادم لتطبيق التغييرات.

للمزيد من المعلومات والمساعدة، يرجى الاتصال بفريق الدعم الفني.